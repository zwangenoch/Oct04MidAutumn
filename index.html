<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oct04 中秋聚会potluck统计表</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            margin-bottom: 10px;
            color: #333;
        }

        .status {
            margin-bottom: 15px;
            padding: 8px 12px;
            background: #e8f5e9;
            border-radius: 4px;
            font-size: 14px;
            color: #2e7d32;
            display: inline-block;
        }

        .status.disconnected {
            background: #ffebee;
            color: #c62828;
        }

        .controls {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background: #45a049;
        }

        button.danger {
            background: #f44336;
        }

        button.danger:hover {
            background: #da190b;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background: #f0f0f0;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        td {
            min-width: 150px;
        }

        input {
            width: 100%;
            border: none;
            padding: 4px;
            font-size: 14px;
            background: transparent;
        }

        input:focus {
            outline: 2px solid #4CAF50;
            background: #f9f9f9;
        }

        .info {
            margin-top: 15px;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 4px;
            font-size: 14px;
            color: #1976d2;
        }

        .editing {
            background: #fff3cd !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Oct04 中秋聚会potluck统计表</h1>
        <p style="margin-bottom: 15px; color: #666; font-size: 14px;">请在菜品后注明姓名，以防忘记</p>
        <div class="status" id="status">正在连接...</div>
        
        
        <div class="controls" style="display: none;">
            <button onclick="exportData()">导出数据</button>
            <button class="danger" onclick="clearAllData()">清空所有数据</button>
        </div>

        <div class="table-wrapper">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>菜品</th>
                        <th>饮品</th>
                        <th>甜品/水果</th>
                        <th>其他</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>

        <div class="info">
            实时同步：所有人都能看到相同的数据，请在菜品后注明姓名方便识别
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, onValue, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase 配置 - 请替换为你的实际配置
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.REGION.firebasedatabase.app",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const ROWS = 50;
        const COLS = 4;
        let db;
        let isConnected = false;

        // 初始化 Firebase
        try {
            const app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            updateStatus(true);
            initTable();
        } catch (error) {
            console.log('Firebase 配置错误，使用本地存储模式');
            updateStatus(false);
            initTableLocal();
        }

        function updateStatus(connected) {
            isConnected = connected;
            const statusEl = document.getElementById('status');
            if (connected) {
                statusEl.textContent = '● 已连接 - 实时同步';
                statusEl.classList.remove('disconnected');
            } else {
                statusEl.textContent = '● 离线模式 - 仅本地保存';
                statusEl.classList.add('disconnected');
            }
        }

        // 初始化表格（Firebase 版本）
        function initTable() {
            const tbody = document.getElementById('tableBody');
            
            for (let i = 0; i < ROWS; i++) {
                const row = tbody.insertRow();
                for (let j = 0; j < COLS; j++) {
                    const cell = row.insertCell();
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = `cell-${i}-${j}`;
                    
                    // 监听数据变化
                    const cellRef = ref(db, `cells/${i}-${j}`);
                    onValue(cellRef, (snapshot) => {
                        const value = snapshot.val();
                        if (value !== null && input.value !== value) {
                            input.value = value;
                        }
                    });
                    
                    // 输入时保存到 Firebase
                    input.addEventListener('input', function() {
                        set(ref(db, `cells/${i}-${j}`), this.value);
                    });

                    // 编辑时高亮
                    input.addEventListener('focus', function() {
                        this.classList.add('editing');
                    });

                    input.addEventListener('blur', function() {
                        this.classList.remove('editing');
                    });
                    
                    cell.appendChild(input);
                }
            }
        }

        // 初始化表格（本地版本）
        function initTableLocal() {
            const tbody = document.getElementById('tableBody');
            const savedData = JSON.parse(localStorage.getItem('tableData') || '{}');
            
            for (let i = 0; i < ROWS; i++) {
                const row = tbody.insertRow();
                for (let j = 0; j < COLS; j++) {
                    const cell = row.insertCell();
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = savedData[`${i}-${j}`] || '';
                    
                    input.addEventListener('input', function() {
                        savedData[`${i}-${j}`] = this.value;
                        localStorage.setItem('tableData', JSON.stringify(savedData));
                    });
                    
                    cell.appendChild(input);
                }
            }
        }

        // 导出数据
        window.exportData = function() {
            const data = [];
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => {
                if (input.value) {
                    data.push({ id: input.id, value: input.value });
                }
            });
            
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'table_data_' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);
        };

        // 清空所有数据
        window.clearAllData = function() {
            if (!confirm('确定要清空所有数据吗？此操作无法撤销！')) return;
            
            if (isConnected) {
                remove(ref(db, 'cells'));
            } else {
                localStorage.removeItem('tableData');
            }
            location.reload();
        };
    </script>
</body>
</html>
